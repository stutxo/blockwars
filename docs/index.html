<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>blockwars.gg</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }

        #canvas {
            max-width: 100%;
            height: auto;
        }

        .github-container {
            position: absolute;
            top: 0;
            right: 40%;
        }
    </style>
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <script type="module">
        (async () => {
            const { instance: a } = await WebAssembly.instantiateStreaming(fetch("./blockwars.wasm")),
                w = 255,
                c = document.getElementById("canvas");
            c.width = w;
            c.height = w;
            const b = a.exports.BUFFER.value,
                i = new ImageData(new Uint8ClampedArray(a.exports.memory.buffer, b, 4 * w * w), w),
                d = c.getContext("2d");

            let lastFrameTime = 0;
            const targetFPS = 60;
            const targetFrameTime = 1000 / targetFPS;

            const r = (currentTime) => {
                requestAnimationFrame(r);

                const deltaTime = currentTime - lastFrameTime;

                if (deltaTime < targetFrameTime) {
                    return;
                }

                lastFrameTime = currentTime - (deltaTime % targetFrameTime);

                const game_loop = a.exports.game_loop();
                console.log(game_loop);
                d.putImageData(i, 0, 0);
            };
            requestAnimationFrame(r);


            var currentDirectionIsLeft = true;

            const allowedKeys = new Set(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd', ' ', 'MouseLeft', 'MouseRight', 'Touch']);

            document.addEventListener('keydown', (event) => {
                if (allowedKeys.has(event.key)) {
                    toggleDirectionAndMove();
                    event.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('mousedown', (event) => {
                const mouseKey = event.button === 0 ? 'MouseLeft' : event.button === 2 ? 'MouseRight' : '';
                if (allowedKeys.has(mouseKey)) {
                    toggleDirectionAndMove();
                    event.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchstart', (event) => {
                if (allowedKeys.has('Touch')) {
                    toggleDirectionAndMove();
                    event.preventDefault();
                }
            }, { passive: false });

            function toggleDirectionAndMove() {
                if (currentDirectionIsLeft) {
                    a.exports.key_pressed(1);
                } else {
                    a.exports.key_pressed(2);
                }
                currentDirectionIsLeft = !currentDirectionIsLeft;
            }


        })();
    </script>
</head>

<body>
    <div class="github-container">
        <a class="github-button" href="https://github.com/stutxo/blockwars" data-show-count="true"
            aria-label="Star stutxo/blockwars on GitHub"></a>
    </div>

    <div id="game-container">
        <canvas id="canvas"></canvas>
    </div>
</body>

</html>
